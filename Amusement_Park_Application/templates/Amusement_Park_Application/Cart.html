{% extends 'common.html' %}
{% load static %}
{% load humanize %}
{% block body %}


<!-- =======================
Page Banner START -->
<br><br>
<section class="py-0">
	<div class="container">
		<div class="row">
			<div class="col-12">
				<div class="bg-light p-4 text-center rounded-3">
					<h1 class="m-0 fs-2">سبد خرید</h1>
					<div class="d-flex justify-content-center">
						<nav aria-label="breadcrumb">
							<ol class="breadcrumb breadcrumb-dots mb-0">
								<li class="breadcrumb-item"><a href="{% url "Amusement_Park:Products" %}">صفحه اصلی</a></li>
								<li class="breadcrumb-item active" aria-current="page">سبد خرید</li>
							</ol>
						</nav>
					</div>
				</div>
			</div>
		</div>
	</div>
</section>
<!-- =======================
Page Banner END -->

<!-- =======================
Page content START -->
<section class="pt-5">
	<div class="container">
	
		<div class="row g-4 g-sm-5">
			<!-- Main content START -->
			<div class="col-lg-8 mb-4 mb-sm-0">
				<div class="card card-body p-4 shadow">
					<div class="table-responsive border-0 rounded-3">
						<!-- Table START -->
						<table class="table align-middle p-4 mb-0">
							<!-- Table head -->
							<!-- Table body START -->
							<tbody class="border-top-0">


								<!-- Table item -->
								{% for item in cart_items %}
								<tr data-ticket-product-id="{{ item.product.id }}">
									<td>
										<div class="d-lg-flex align-items-center">
											<div class="w-100px w-md-80px mb-2 mb-md-0">
												<img src="{{ item.product.image.url }}" class="rounded" alt="">
											</div>
											<h6 class="mb-0 ms-lg-3 mt-2 mt-lg-0">
												<a style="font-size: 75%;">{{ item.product.title }}</a>
											</h6>
										</div>
									</td>
									<td class="text-center">
										<h5 class="text-success mb-0" style="font-size: 75%;">{{ item.product.price|intcomma }} ریال</h5>
									</td>
									<td>
										<div class="d-flex justify-content-between align-items-center">
											<button class="btn btn-outline-warning btn-sm" onclick="removeItem(this, {{ item.product.id }})"><i class="fas fa-trash"></i></button>
											<button class="btn btn-outline-danger btn-sm" disabled onclick="increment(this)">+</button>
											<button class="btn btn-outline-primary btn-sm counter" disabled data-product-id="{{ item.product.id }}">{{ item.quantity }}</button>
											<button class="btn btn-outline-danger btn-sm" disabled onclick="decrement(this)">-</button>
										</div>
									</td>
								</tr> 
								{% endfor %}
								<!-- Table item -->

								
							</tbody>
						</table>
					</div>

						<!-- Coupon input and button -->
						<div class="row g-3 mt-2">
							<div class="col-md-6">
								<div class="input-group">
									<input class="form-control" id="discount-code" placeholder="تخفیف با کد تخفیف :">
								</div>
								<small id="tip-code" class="form-text text-muted" style="display: none;"></small>
							</div>
							<!-- Update button -->
							<div class="col-md-6 text-md-end">
								<button class="btn btn-primary mb-0" id="btn-code" disabled>اعمال</button>
							</div>
						</div>

						{% if request.user.is_superuser or request.user.is_staff %}
						<!-- Coupon input and button -->
							<div class="row g-3 mt-2">
								<div class="col-md-6">
									<div class="input-group">
										<input class="form-control" id="discount-amount" placeholder="تخفیف با مبلغ :">
									</div>
									<small id="tip-amount" class="form-text text-muted" style="display: none;"></small>
								</div>
								<!-- Update button -->
								<div class="col-md-6 text-md-end">
									<button class="btn btn-primary mb-0" id="btn-amount" disabled>اعمال</button>
								</div>
							</div>

							<!-- Coupon input and button -->
							<div class="row g-3 mt-2">
								<div class="col-md-6">
									<div class="input-group">
										<input class="form-control" id="discount-percent" placeholder="تخفیف با درصد :">
									</div>
									<small id="tip-percent" class="form-text text-muted" style="display: none;"></small>
								</div>
								<!-- Update button -->
								<div class="col-md-6 text-md-end">
									<button class="btn btn-primary mb-0" id="btn-percent" disabled>اعمال</button>
								</div>
							</div>
						{% endif %}

				</div>
			</div>
			<!-- Main content END -->

			<!-- Right sidebar START -->
			<div class="col-lg-4">
				<!-- Card total START -->
				<div class="card card-body p-4 shadow">
					<!-- Title -->
					<h4 class="mb-3 fs-5 text-center">صورت حساب</h4>
					<hr>

					<!-- Price and detail -->
					<ul class="list-group list-group-borderless mb-2">
						<li class="list-group-item px-0 d-flex justify-content-between">
							<span class="h6 fw-light mb-0">قیمت</span>
							<span class="h6 fw-light mb-0 fw-bold" id="item-total-price"> ریال</span> <!-- Dynamic price -->
						</li>
						<li class="list-group-item px-0 d-flex justify-content-between">
							<span class="h6 fw-light mb-0">مالیات (%{{ get_TaxRate.rate|floatformat:0 }})</span>
							<span class="h6 fw-light mb-0 fw-bold" id="tax-amount">0 ریال</span> <!-- Dynamic tax -->
						</li>
						<li class="list-group-item px-0 d-flex justify-content-between">
							<span class="h6 fw-light mb-0">تخفیف</span>
							<span class="h6 fw-light mb-0 fw-bold"  id="discount-display">0 ریال</span>
						</li>
						<br>
						<li class="list-group-item px-0 d-flex justify-content-between">
							<span class="h5 mb-0">قیمت نهایی</span>
							<span class="text-danger h5">500,000 ریال</span>
						</li>
					</ul>
					<hr>

					<!-- Button -->
					<div class="d-grid">
						<a href='{% url "Amusement_Park:Checkout" %}' class="btn btn-lg btn-success">تسویه حساب</a>
					</div>
				</div>
				<!-- Card total END -->
			</div>
			<!-- Right sidebar END -->

		</div><!-- Row END -->
	</div>
</section>
<!-- =======================
Page content END -->
{% endblock body %}



{% block script %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Function to increment the counter
    function increment(button) {
        const counter = button.parentElement.querySelector('.counter');
        let count = parseInt(counter.innerText, 10);
        counter.innerText = count + 1;
        updateTotalPrice(counter.dataset.productId, count + 1);
    }

    // Function to decrement the counter
    function decrement(button) {
        const counter = button.parentElement.querySelector('.counter');
        let count = parseInt(counter.innerText, 10);
        if (count > 0) {
            counter.innerText = count - 1;
            updateTotalPrice(counter.dataset.productId, count - 1);
        }
    }

    // Function to update the total price via AJAX
    function updateTotalPrice(productId, newQuantity) {
        fetch("{% url 'Amusement_Park:update_item_quantity' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({
                'product_id': productId,
                'quantity': newQuantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                fetchTotalPrice();
            }
        })
        .catch(error => {
            console.log('Error:', error);
        });
    }

    // Function to fetch and display the total price
	function fetchTotalPrice() {
		fetch("{% url 'Amusement_Park:calculate_total_price' %}")
		.then(response => response.json())
		.then(data => {
			// Update total price
			document.getElementById('item-total-price').innerText = data.total_price.toLocaleString() + ' ریال';
	
			document.getElementById('tax-amount').innerText = data.tax.toLocaleString() + ' ریال';
			// Update tax amount
		})
		.catch(error => {
			console.log('Error:', error);
		});
	}

    // Fetch the total price when the page loads
    document.addEventListener('DOMContentLoaded', fetchTotalPrice);

    document.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', function() {
			const buttonId = 'btn-' + this.id.split('-')[1];
            const tipId = 'tip-' + this.id.split('-')[1];
            const button = document.getElementById(buttonId);
            const tip = document.getElementById(tipId);
            
            // Reset previous form if another form is being typed in
            document.querySelectorAll('input').forEach(otherInput => {
				if (otherInput !== this && otherInput.value.trim() !== '') {
					otherInput.value = '';
                    document.getElementById('btn-' + otherInput.id.split('-')[1]).setAttribute('disabled', true);
                    document.getElementById('tip-' + otherInput.id.split('-')[1]).style.display = 'none';
                }
            });
			
            // Enable/Disable button and show tip
            if (this.value.trim() !== '') {
				button.removeAttribute('disabled');
                tip.style.display = 'inline';
                tip.textContent = this.getAttribute('data-tip');
            } else {
                button.setAttribute('disabled', true);
                tip.style.display = 'none';
            }
        });
    });
	
	
	// Check if the page is being loaded for the first time
	if (performance.navigation.type === 1) {
		window.location.href = "{% url 'Amusement_Park:Products' %}";
	}

	// Function to handle item removal from the cart
	function removeItem(button, productId) {
		// Remove the item row from the table
		const row = button.closest('tr');
		row.remove();

		// Send AJAX request to delete the item from the session
		fetch("{% url 'Amusement_Park:remove_item_from_cart' %}", {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': '{{ csrf_token }}',
			},
			body: JSON.stringify({ 'product_id': productId })
		})
		.then(response => response.json())
		.then(data => {
			if (data.success) {
				console.log('Item removed successfully');
				if (data.cart_empty) {
					// Redirect to the products page if the cart is empty
					window.location.href = "{% url 'Amusement_Park:Products' %}";
				}
			} else {
				console.log('Failed to remove item');
			}
		})
		.catch(error => {
			console.log('Error:', error);
		});
	}

	// Function to apply discount
	function applyDiscount() {
		const discountInput = document.getElementById('discount-amount');
		const discountValue = parseFloat(discountInput.value);  // Convert input to number
		const totalPrice = parseFloat(document.getElementById('item-total-price').innerText.replace(/,/g, ''));  // Get total price
		const taxAmount = parseFloat(document.getElementById('tax-amount').innerText.replace(/,/g, ''));  // Get tax amount
		const maxDiscount = totalPrice + taxAmount;  // Calculate maximum allowed discount

		if (isNaN(discountValue) || discountValue <= 0) {
			Swal.fire({
				title: 'خطا!',
				text: 'لطفاً یک مقدار معتبر برای تخفیف وارد کنید.',
				icon: 'error',
				confirmButtonText: 'باشه'
			});
			return;
		}

		if (discountValue > maxDiscount) {
			Swal.fire({
				title: 'خطا!',
				text: `حداکثر مقدار تخفیف قابل اعمال ${maxDiscount.toLocaleString()} ریال است.`,
				icon: 'error',
				confirmButtonText: 'باشه'
			});
			return;
		}

		// Update discount display
		document.getElementById('discount-display').innerText = discountValue.toLocaleString() + ' ریال';

		// Show success notification
		Swal.fire({
			title: 'تخفیف اعمال شد!',
			text: `تخفیف ${discountValue.toLocaleString()} ریال با موفقیت اعمال شد.`,
			icon: 'success',
			confirmButtonText: 'باشه'
		});
	}

	// Add event listener to the discount button
	document.getElementById('btn-amount').addEventListener('click', applyDiscount);

	// Enable/disable discount button based on input
	document.getElementById('discount-amount').addEventListener('input', function() {
		const discountButton = document.getElementById('btn-amount');
		if (this.value.trim() !== '') {
			discountButton.removeAttribute('disabled');
		} else {
			discountButton.setAttribute('disabled', true);
		}
	});


	// Function to apply percentage discount
	function applyPercentageDiscount() {
		const discountPercentInput = document.getElementById('discount-percent');
		const discountPercentValue = parseFloat(discountPercentInput.value);  // Convert input to number
		const totalPrice = parseFloat(document.getElementById('item-total-price').innerText.replace(/,/g, ''));  // Get total price
		const taxAmount = parseFloat(document.getElementById('tax-amount').innerText.replace(/,/g, ''));  // Get tax amount
		const totalAmount = totalPrice + taxAmount;  // Calculate total amount (price + tax)

		// Validate input
		if (isNaN(discountPercentValue) || discountPercentValue < 1 || discountPercentValue > 100) {
			Swal.fire({
				title: 'خطا!',
				text: 'لطفاً یک درصد معتبر بین ۱ تا ۱۰۰ وارد کنید.',
				icon: 'error',
				confirmButtonText: 'باشه'
			});
			return;
		}

		// Calculate discount amount
		const discountAmount = (totalAmount / 100) * discountPercentValue;

		// Update discount display
		document.getElementById('discount-display').innerText = discountAmount.toLocaleString() + ' ریال';

		// Show success notification
		Swal.fire({
			title: 'تخفیف اعمال شد!',
			text: `تخفیف ${discountPercentValue}% (${discountAmount.toLocaleString()} ریال) با موفقیت اعمال شد.`,
			icon: 'success',
			confirmButtonText: 'باشه'
		});
	}

	// Add event listener to the percentage discount button
	document.getElementById('btn-percent').addEventListener('click', applyPercentageDiscount);

	// Enable/disable percentage discount button based on input
	document.getElementById('discount-percent').addEventListener('input', function() {
		const discountPercentButton = document.getElementById('btn-percent');
		if (this.value.trim() !== '') {
			discountPercentButton.removeAttribute('disabled');
		} else {
			discountPercentButton.setAttribute('disabled', true);
		}
	});


</script>
{% endblock script %}



