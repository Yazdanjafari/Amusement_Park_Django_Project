{% extends 'common.html' %}
{% load static %}
{% load humanize %}


{% block style %}
	<style>
		.form-label {
			display: block; /* نمایش label به صورت بلوکی */
			font-size: 14px; /* اندازه فونت */
			font-weight: 600; /* ضخامت فونت */
			color: #2c3e50; /* رنگ متن */
			margin-bottom: 8px; /* فاصله از فیلد input */
		}
		
		.bg-light-input {
			margin-bottom: 16px; /* فاصله بین فیلدها */
		}
		
		.form-control {
			width: 100%; /* عرض کامل */
			padding: 10px; /* فاصله داخلی */
			font-size: 14px; /* اندازه فونت */
			border: 1px solid #ced4da; /* حاشیه */
			border-radius: 6px; /* لبه‌های گرد */
			transition: border-color 0.3s ease; /* انیمیشن تغییر رنگ حاشیه */
		}
		
		.form-control:focus {
			border-color: #80bdff; /* تغییر رنگ حاشیه هنگام فوکوس */
			box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); /* سایه هنگام فوکوس */
			outline: none; /* حذف outline پیش‌فرض */
		}

		select.form-control {
			appearance: none; /* حذف فلش پیش‌فرض */
			background-color: #f8f9fa; /* رنگ پس‌زمینه */
			border: 1px solid #ced4da; /* حاشیه */
			border-radius: 6px; /* لبه‌های گرد */
			padding: 8px 12px; /* فاصله داخلی */
			font-size: 14px; /* اندازه فونت */
			cursor: pointer; /* تغییر شکل نشانگر ماوس */
			width: 100%; /* عرض کامل */
		}
		
		select.form-control:focus {
			border-color: #80bdff; /* تغییر رنگ حاشیه هنگام فوکوس */
			box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); /* سایه هنگام فوکوس */
			outline: none; /* حذف outline پیش‌فرض */
		}		
	</style>
{% endblock style %}
	

{% block body %}


<!-- =======================
Page Banner START -->
<br><br>
<section class="py-0">
	<div class="container">
		<div class="row">
			<div class="col-12">
				<div class="bg-light p-4 text-center rounded-3">
					<h1 class="m-0 fs-2">سبد خرید</h1>
					<div class="d-flex justify-content-center">
						<nav aria-label="breadcrumb">
							<ol class="breadcrumb breadcrumb-dots mb-0">
								<li class="breadcrumb-item"><a href="{% url "Amusement_Park:Products" %}">صفحه اصلی</a></li>
								<li class="breadcrumb-item active" aria-current="page">سبد خرید</li>
							</ol>
						</nav>
					</div>
				</div>
			</div>
		</div>
	</div>
</section>
<!-- =======================
Page Banner END -->

<!-- =======================
Page content START -->
<section class="pt-5">
	<div class="container">
	
		<div class="row g-4 g-sm-5">
			<!-- Main content START -->
			<div class="col-lg-8 mb-4 mb-sm-0">
				<div class="card card-body p-4 shadow">
					<div class="table-responsive border-0 rounded-3">
						<!-- Table START -->
						<table class="table align-middle p-4 mb-0">
							<!-- Table body START -->
							<tbody class="border-top-0">
								<!-- Table item -->
								{% for item in cart_items %}
									<tr data-ticket-product-id="{{ item.product.id }}">
										<td>
											<div class="d-lg-flex align-items-center">
												<div class="w-100px w-md-80px mb-2 mb-md-0">
													<img src="{{ item.product.image.url }}" class="rounded" alt="">
												</div>
												<h6 class="mb-0 ms-lg-3 mt-2 mt-lg-0">
													<a style="font-size: 75%;">{{ item.product.title }}</a>
												</h6>
											</div>
										</td>
										<td class="text-center">
											<h5 class="text-success mb-0" style="font-size: 75%;">{{ item.product.price|intcomma }} ریال</h5>
										</td>
										<td>
											<div class="d-flex justify-content-between align-items-center">
												<button class="btn btn-success btn-sm" disabled><i class="bi bi-cart"></i></button>
												<button class="btn btn-outline-danger btn-sm" disabled onclick="increment(this)">+</button>
												<button class="btn btn-outline-primary btn-sm counter" disabled data-product-id="{{ item.product.id }}">{{ item.quantity }}</button>
												<button class="btn btn-outline-danger btn-sm" disabled onclick="decrement(this)">-</button>
											</div>
										</td>
									</tr>
								{% endfor %}
								<!-- Table item -->
							</tbody>
							<!-- Table body END -->
						</table>
						<!-- Table END -->
					</div>

					<!-- Title -->
					<br>
					<h5 class="mb-0">اطلاعات مشتری (اختیاری) :</h5>
					<br>
					<label class="discount-label">با پر کردن این فرم از تخفیف های هیجان انگیز با بهره مند شوید !</label>
					<form class="row g-3 mt-0">

						<div class="input-group mt-2">
							<input id="phoneInput" name="phone" class="form-control" placeholder="شماره تماس (مثال : 09120000000)" type="text" maxlength="11" minlength="11">
							<button id="applyButton" type="button" class="btn btn-primary" disabled>اعمال</button>
						</div>
					
						<div class="col-md-6 bg-light-input">
							<label for="firstName" class="form-label">نام :</label>
							<input type="text" id="firstName" name="firstName" class="form-control">
						</div>
						
						<div class="col-md-6 bg-light-input">
							<label for="lastName" class="form-label">نام خانوادگی :</label>
							<input type="text" id="lastName" name="lastName" class="form-control">
						</div>
						
						<div class="col-md-4 bg-light-input">
							<label for="birthDay" class="form-label">روز تولد :</label>
							<select id="birthDay" name="birthDay" class="form-control">
								<option value="" disabled selected></option>
								<option value="1">1</option>
								<option value="2">2</option>
								<option value="3">3</option>
								<option value="4">4</option>
								<option value="5">5</option>
								<option value="6">6</option>
								<option value="7">7</option>
								<option value="8">8</option>
								<option value="9">9</option>
								<option value="10">10</option>
								<option value="11">11</option>
								<option value="12">12</option>
								<option value="13">13</option>
								<option value="14">14</option>
								<option value="15">15</option>
								<option value="16">16</option>
								<option value="17">17</option>
								<option value="18">18</option>
								<option value="19">19</option>
								<option value="20">20</option>
								<option value="21">21</option>
								<option value="22">22</option>
								<option value="23">23</option>
								<option value="24">24</option>
								<option value="25">25</option>
								<option value="26">26</option>
								<option value="27">27</option>
								<option value="28">28</option>
								<option value="29">29</option>
								<option value="30">30</option>
								<option value="31">31</option>
							</select>
						</div>
						
						<div class="col-md-4 bg-light-input">
							<label for="birthMonth" class="form-label">ماه تولد :</label>
							<select id="birthMonth" name="birthMonth" class="form-control">
								<option value="" disabled selected></option> <!-- Placeholder -->
								<option value="1">1</option>
								<option value="2">2</option>
								<option value="3">3</option>
								<option value="4">4</option>
								<option value="5">5</option>
								<option value="6">6</option>
								<option value="7">7</option>
								<option value="8">8</option>
								<option value="9">9</option>
								<option value="10">10</option>
								<option value="11">11</option>
								<option value="12">12</option>
							</select>
						</div>
						
						<div class="col-md-4 bg-light-input">
							<label for="birthYear" class="form-label">سال تولد :</label>
							<select id="birthYear" name="birthYear" class="form-control">
								<option value="" disabled selected></option>
								<option value="1395">1395</option>
								<option value="1394">1394</option>
								<option value="1393">1393</option>
								<option value="1392">1392</option>
								<option value="1391">1391</option>
								<option value="1390">1390</option>
								<option value="1389">1389</option>
								<option value="1388">1388</option>
								<option value="1387">1387</option>
								<option value="1386">1386</option>
								<option value="1385">1385</option>
								<option value="1384">1384</option>
								<option value="1383">1383</option>
								<option value="1382">1382</option>
								<option value="1381">1381</option>
								<option value="1380">1380</option>
								<option value="1379">1379</option>
								<option value="1378">1378</option>
								<option value="1377">1377</option>
								<option value="1376">1376</option>
								<option value="1375">1375</option>
								<option value="1374">1374</option>
								<option value="1373">1373</option>
								<option value="1372">1372</option>
								<option value="1371">1371</option>
								<option value="1370">1370</option>
								<option value="1369">1369</option>
								<option value="1368">1368</option>
								<option value="1367">1367</option>
								<option value="1366">1366</option>
								<option value="1365">1365</option>
								<option value="1364">1364</option>
								<option value="1363">1363</option>
								<option value="1362">1362</option>
								<option value="1361">1361</option>
								<option value="1360">1360</option>
								<option value="1359">1359</option>
								<option value="1358">1358</option>
								<option value="1357">1357</option>
								<option value="1356">1356</option>
								<option value="1355">1355</option>
								<option value="1354">1354</option>
								<option value="1353">1353</option>
								<option value="1352">1352</option>
								<option value="1351">1351</option>
								<option value="1350">1350</option>
								<option value="1349">1349</option>
								<option value="1348">1348</option>
								<option value="1347">1347</option>
								<option value="1346">1346</option>
								<option value="1345">1345</option>
								<option value="1344">1344</option>
								<option value="1343">1343</option>
								<option value="1342">1342</option>
								<option value="1341">1341</option>
								<option value="1340">1340</option>
								<option value="1339">1339</option>
								<option value="1338">1338</option>
								<option value="1337">1337</option>
								<option value="1336">1336</option>
								<option value="1335">1335</option>
								<option value="1334">1334</option>
								<option value="1333">1333</option>
								<option value="1332">1332</option>
								<option value="1331">1331</option>
								<option value="1330">1330</option>
								<option value="1329">1329</option>
								<option value="1328">1328</option>
								<option value="1327">1327</option>
								<option value="1326">1326</option>
								<option value="1325">1325</option>
								<option value="1324">1324</option>
								<option value="1323">1323</option>
								<option value="1322">1322</option>
								<option value="1321">1321</option>
								<option value="1320">1320</option>
								<option value="1319">1319</option>
								<option value="1318">1318</option>
								<option value="1317">1317</option>
								<option value="1316">1316</option>
								<option value="1315">1315</option>
								<option value="1314">1314</option>
								<option value="1313">1313</option>
								<option value="1312">1312</option>
								<option value="1311">1311</option>
								<option value="1310">1310</option>
							</select>
						</div>
					
						<div class="col-12 text-end p-0">
							<button type="submit" class="btn btn-primary w-100 mb-0" disabled>ذخیره</button>
						</div>
					</form>
					<!-- Form END -->

					<!-- Coupon input and button -->
					<hr>
					<h5 class="mb-0">تخفیف :</h5>
					<div class="row g-3 mt-2">
						<div class="col-md-6">
							<div class="input-group">
								<input class="form-control discount-input" id="discount-code" placeholder="تخفیف با کد تخفیف :">
							</div>
							<small id="tip-code" class="form-text text-muted" style="display: none;"></small>
						</div>
						<!-- Update button -->
						<div class="col-md-6 text-md-end">
							<button class="btn btn-primary mb-0" id="btn-code" disabled>اعمال</button>
						</div>
					</div>

					{% if request.user.is_superuser or request.user.is_staff %}
					<!-- Coupon input and button -->
					<div class="row g-3 mt-2">
						<div class="col-md-6">
							<div class="input-group">
								<input class="form-control discount-input" id="discount-amount" placeholder="تخفیف با مبلغ :">
							</div>
							<small id="tip-amount" class="form-text text-muted" style="display: none;"></small>
						</div>
						<!-- Update button -->
						<div class="col-md-6 text-md-end">
							<button class="btn btn-primary mb-0" id="btn-amount" disabled>اعمال</button>
						</div>
					</div>

					<!-- Coupon input and button -->
					<div class="row g-3 mt-2">
						<div class="col-md-6">
							<div class="input-group">
								<input class="form-control discount-input" id="discount-percent" placeholder="تخفیف با درصد :">
							</div>
							<small id="tip-percent" class="form-text text-muted" style="display: none;"></small>
						</div>
						<!-- Update button -->
						<div class="col-md-6 text-md-end">
							<button class="btn btn-primary mb-0" id="btn-percent" disabled>اعمال</button>
						</div>
					</div>
					{% endif %}

					<!-- Title -->
					<hr>
					<h5 class="">روش های پرداخت :</h5>
					<div class="col-12">
						<div class="accordion accordion-circle" id="accordioncircle">

							<!-- Card reader (Default) -->
							<div class="accordion-item mb-3">
								<h6 class="accordion-header" id="heading-card-reader">
									<button class="accordion-button rounded" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-card-reader" aria-expanded="true" aria-controls="collapse-card-reader">
										دستگاه کارتخوان
									</button>
								</h6>
								<div id="collapse-card-reader" class="accordion-collapse collapse show" aria-labelledby="heading-card-reader" data-bs-parent="#accordioncircle">
								</div>
							</div>

							{% if request.user.is_superuser or request.user.is_staff %}
							<!-- Cash -->
							<div class="accordion-item mb-3">
								<h6 class="accordion-header" id="heading-cash">
									<button class="accordion-button collapsed rounded" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-cash" aria-expanded="false" aria-controls="collapse-cash">
										نقدی
									</button>
								</h6>
								<div id="collapse-cash" class="accordion-collapse collapse" aria-labelledby="heading-cash" data-bs-parent="#accordioncircle">
								</div>
							</div>

							<!-- Combined payment -->
							<div class="accordion-item mb-3">
								<h6 class="accordion-header" id="heading-combined">
									<button class="accordion-button collapsed rounded" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-combined" aria-expanded="false" aria-controls="collapse-combined">
										ترکیبی
									</button>
								</h6>
								<div id="collapse-combined" class="accordion-collapse collapse" aria-labelledby="heading-combined" data-bs-parent="#accordioncircle">
									<!-- Accordion body -->
									<div class="accordion-body">
										<!-- Form START -->
										<form class="row g-3">
											<div class="col-6">
												<label class="form-label"><span class="text-danger">* مقدار مبلغ نقدی</span></label>
												<input type="text" class="form-control" aria-label="cash amount" placeholder="مبلغ نقدی را وارد کنید">
											</div>
											<div class="col-6">
												<label class="form-label"><span class="text-danger">* مقدار مبلغ پرداخت با کارتخوان</span></label>
												<input type="text" class="form-control" aria-label="card amount" placeholder="مبلغ کارتخوان را وارد کنید">
											</div>
										</form>
										<!-- Form END -->
									</div>
								</div>
							</div>
							{% endif %}
							<!-- Credit or debit card END -->

							<!-- Net banking END -->
						</div>
					</div>
					<!-- Payment method END -->
				</div>
			</div>
			<!-- Main content END -->

			<!-- Right sidebar START -->
			<div class="col-lg-4">
				<!-- Card total START -->
				<div class="card card-body p-4 shadow">
					<!-- Title -->
					<h4 class="mb-3 fs-5 text-center">صورت حساب</h4>
					<hr>

					<!-- Price and detail -->
					<ul class="list-group list-group-borderless mb-2">
						<li class="list-group-item px-0 d-flex justify-content-between">
							<span class="h6 fw-light mb-0">قیمت</span>
							<span class="h6 fw-light mb-0 fw-bold" id="item-total-price"> ریال</span> <!-- Dynamic price -->
						</li>
						<li class="list-group-item px-0 d-flex justify-content-between">
							<span class="h6 fw-light mb-0">مالیات (%{{ get_TaxRate.rate|floatformat:0 }})</span>
							<span class="h6 fw-light mb-0 fw-bold" id="tax-amount">0 ریال</span> <!-- Dynamic tax -->
						</li>
						<li class="list-group-item px-0 d-flex justify-content-between">
							<span class="h6 fw-light mb-0">تخفیف</span>
							<span class="h6 fw-light mb-0 fw-bold"  id="discount-display">0 ریال</span>
						</li>
						<br>
						<li class="list-group-item px-0 d-flex justify-content-between">
							<span class="h5 mb-0">قیمت نهایی</span>
							<span class="text-danger h5" id="final-price">0 ریال</span>
						</li>
					</ul>
					<hr>

					<!-- Button -->
					<div class="d-grid">
						<a href='' class="btn btn-lg btn-success">پرداخت</a>
						<a href='{% url "Amusement_Park:Products" %}' class="btn btn-lg btn-outline-danger">لغو</a>
					</div>
				</div>
				<!-- Card total END -->
			</div>
			<!-- Right sidebar END -->

		</div><!-- Row END -->
	</div>
</section>
<!-- =======================
Page content END -->
{% endblock body %}



{% block script %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Function to increment the counter
    function increment(button) {
        const counter = button.parentElement.querySelector('.counter');
        let count = parseInt(counter.innerText, 10);
        counter.innerText = count + 1;
        updateTotalPrice(counter.dataset.productId, count + 1);
    }

    // Function to decrement the counter
    function decrement(button) {
        const counter = button.parentElement.querySelector('.counter');
        let count = parseInt(counter.innerText, 10);
        if (count > 0) {
            counter.innerText = count - 1;
            updateTotalPrice(counter.dataset.productId, count - 1);
        }
    }

    // Function to update the total price via AJAX
    function updateTotalPrice(productId, newQuantity) {
        fetch("{% url 'Amusement_Park:update_item_quantity' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({
                'product_id': productId,
                'quantity': newQuantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                fetchTotalPrice();
            }
        })
        .catch(error => {
            console.log('Error:', error);
        });
    }

    // Function to fetch and display the total price
	function fetchTotalPrice() {
		fetch("{% url 'Amusement_Park:calculate_total_price' %}")
		.then(response => response.json())
		.then(data => {
			// Update total price
			document.getElementById('item-total-price').innerText = data.total_price.toLocaleString() + ' ریال';
	
			// Update tax amount
			document.getElementById('tax-amount').innerText = data.tax.toLocaleString() + ' ریال';

			// Update final price
			updateFinalPrice();
		})
		.catch(error => {
			console.log('Error:', error);
		});
	}

    // Fetch the total price when the page loads
    document.addEventListener('DOMContentLoaded', fetchTotalPrice);

	document.querySelectorAll('.discount-input').forEach(input => {
		input.addEventListener('input', function () {
			const buttonId = 'btn-' + this.id.split('-')[1];
			const tipId = 'tip-' + this.id.split('-')[1];
			const button = document.getElementById(buttonId);
			const tip = document.getElementById(tipId);
	
			// Reset previous discount inputs if another discount input is being typed in
			document.querySelectorAll('.discount-input').forEach(otherInput => {
				if (otherInput !== this && otherInput.value.trim() !== '') {
					otherInput.value = '';
					document.getElementById('btn-' + otherInput.id.split('-')[1]).setAttribute('disabled', true);
					document.getElementById('tip-' + otherInput.id.split('-')[1]).style.display = 'none';
				}
			});
	
			// Enable/Disable button and show tip
			if (this.value.trim() !== '') {
				button.removeAttribute('disabled');
				tip.style.display = 'inline';
				tip.textContent = this.getAttribute('data-tip');
			} else {
				button.setAttribute('disabled', true);
				tip.style.display = 'none';
			}
		});
	});
	
	
	// Check if the page is being loaded for the first time
	if (performance.navigation.type === 1) {
		window.location.href = "{% url 'Amusement_Park:Products' %}";
	}

	let isDiscountApplied = false;

	// Function to apply discount
	function applyDiscount() {
		const discountInput = document.getElementById('discount-amount');
		const discountValue = parseFloat(discountInput.value);  // Convert input to number
		const totalPrice = parseFloat(document.getElementById('item-total-price').innerText.replace(/,/g, ''));  // Get total price
		const taxAmount = parseFloat(document.getElementById('tax-amount').innerText.replace(/,/g, ''));  // Get tax amount
		const maxDiscount = totalPrice + taxAmount;  // Calculate maximum allowed discount

		if (isNaN(discountValue) || discountValue <= 0) {
			Swal.fire({
				title: 'خطا!',
				text: 'لطفاً یک مقدار معتبر برای تخفیف وارد کنید.',
				icon: 'error',
				confirmButtonText: 'باشه'
			});
			return;
		}

		if (discountValue > maxDiscount) {
			Swal.fire({
				title: 'خطا!',
				text: `حداکثر مقدار تخفیف قابل اعمال ${maxDiscount.toLocaleString()} ریال است.`,
				icon: 'error',
				confirmButtonText: 'باشه'
			});
			return;
		}

		// Update discount display
		document.getElementById('discount-display').innerText = discountValue.toLocaleString() + ' ریال';

		// Show success notification
		Swal.fire({
			title: 'تخفیف اعمال شد!',
			text: `تخفیف ${discountValue.toLocaleString()} ریال با موفقیت اعمال شد.`,
			icon: 'success',
			confirmButtonText: 'باشه'
		});
		    // Set discount applied flag
    			isDiscountApplied = true;
				updateFinalPrice();
	}

	// Add event listener to the discount button
	document.getElementById('btn-amount').addEventListener('click', applyDiscount);

	// Enable/disable discount button based on input
	document.getElementById('discount-amount').addEventListener('input', function() {
		const discountButton = document.getElementById('btn-amount');
		if (this.value.trim() !== '') {
			discountButton.removeAttribute('disabled');
		} else {
			discountButton.setAttribute('disabled', true);
		}
	});


	// Function to apply percentage discount
	function applyPercentageDiscount() {
		const discountPercentInput = document.getElementById('discount-percent');
		const discountPercentValue = parseFloat(discountPercentInput.value);  // Convert input to number
		const totalPrice = parseFloat(document.getElementById('item-total-price').innerText.replace(/,/g, ''));  // Get total price
		const taxAmount = parseFloat(document.getElementById('tax-amount').innerText.replace(/,/g, ''));  // Get tax amount
		const totalAmount = totalPrice + taxAmount;  // Calculate total amount (price + tax)

		// Validate input
		if (isNaN(discountPercentValue) || discountPercentValue < 1 || discountPercentValue > 100) {
			Swal.fire({
				title: 'خطا!',
				text: 'لطفاً یک درصد معتبر بین ۱ تا ۱۰۰ وارد کنید.',
				icon: 'error',
				confirmButtonText: 'باشه'
			});
			return;
		}

		// Calculate discount amount
		const discountAmount = (totalAmount / 100) * discountPercentValue;

		// Update discount display
		document.getElementById('discount-display').innerText = discountAmount.toLocaleString() + ' ریال';

		// Show success notification
		Swal.fire({
			title: 'تخفیف اعمال شد!',
			text: `تخفیف ${discountPercentValue}% (${discountAmount.toLocaleString()} ریال) با موفقیت اعمال شد.`,
			icon: 'success',
			confirmButtonText: 'باشه'
		});
		    // Set discount applied flag
    			isDiscountApplied = true;
				updateFinalPrice();
	}

	// Add event listener to the percentage discount button
	document.getElementById('btn-percent').addEventListener('click', applyPercentageDiscount);

	// Enable/disable percentage discount button based on input
	document.getElementById('discount-percent').addEventListener('input', function() {
		const discountPercentButton = document.getElementById('btn-percent');
		if (this.value.trim() !== '') {
			discountPercentButton.removeAttribute('disabled');
		} else {
			discountPercentButton.setAttribute('disabled', true);
		}
	});


	// Function to apply discount code
	function applyDiscountCode() {
		const discountCodeInput = document.getElementById('discount-code');
		const discountCode = discountCodeInput.value.trim().toLowerCase();  // Normalize the input

		if (!discountCode) {
			Swal.fire({
				title: 'خطا!',
				text: 'لطفاً یک کد تخفیف وارد کنید.',
				icon: 'error',
				confirmButtonText: 'باشه'
			});
			return;
		}

		// Fetch discount code details from the server
		fetch(`{% url 'Amusement_Park:check_discount_code' %}?code=${discountCode}`)
		.then(response => response.json())
		.then(data => {
			if (data.success) {
				const totalPrice = parseFloat(document.getElementById('item-total-price').innerText.replace(/,/g, ''));  // Get total price
				const taxAmount = parseFloat(document.getElementById('tax-amount').innerText.replace(/,/g, ''));  // Get tax amount
				const totalAmount = totalPrice + taxAmount;  // Calculate total amount (price + tax)
				const discountAmount = (totalAmount / 100) * data.percent;  // Calculate discount amount

				// Update discount display
				document.getElementById('discount-display').innerText = discountAmount.toLocaleString() + ' ریال';

				// Show success notification
				Swal.fire({
					title: 'تخفیف اعمال شد!',
					text: data.message,
					icon: 'success',
					confirmButtonText: 'باشه'
				});
				    // Set discount applied flag
    			isDiscountApplied = true;
				updateFinalPrice();
			} else {
				// Show error notification
				Swal.fire({
					title: 'خطا!',
					text: data.message,
					icon: 'error',
					confirmButtonText: 'باشه'
				});
			}
		})
		.catch(error => {
			console.log('Error:', error);
		});
	}

	// Add event listener to the discount code button
	document.getElementById('btn-code').addEventListener('click', applyDiscountCode);

	// Enable/disable discount code button based on input
	document.getElementById('discount-code').addEventListener('input', function() {
		const discountCodeButton = document.getElementById('btn-code');
		if (this.value.trim() !== '') {
			discountCodeButton.removeAttribute('disabled');
		} else {
			discountCodeButton.setAttribute('disabled', true);
		}
	});

	// Restrict input to lowercase English letters
	document.getElementById('discount-code').addEventListener('input', function() {
		this.value = this.value.toLowerCase().replace(/[^a-z]/g, '');
	});	


	// Function to update the final price
	function updateFinalPrice() {
		const totalPrice = parseFloat(document.getElementById('item-total-price').innerText.replace(/,/g, ''));  // Get total price
		const taxAmount = parseFloat(document.getElementById('tax-amount').innerText.replace(/,/g, ''));  // Get tax amount
		const discountAmount = parseFloat(document.getElementById('discount-display').innerText.replace(/,/g, ''));  // Get discount amount

		// Calculate final price
		const finalPrice = totalPrice + taxAmount - discountAmount;

		// Update final price display
		document.getElementById('final-price').innerText = finalPrice.toLocaleString() + ' ریال';
	}

	document.addEventListener('DOMContentLoaded', function() {
		fetchTotalPrice();
		updateFinalPrice();  // Update final price on page load
	});


    const phoneInput = document.getElementById('phoneInput');
    const applyButton = document.getElementById('applyButton');
    phoneInput.addEventListener('input', function () {
        if (phoneInput.value.length === 11) {
            applyButton.disabled = false; 
        } else {
            applyButton.disabled = true;
        }
    });	




	const birthDay = document.getElementById('birthDay');
    const birthMonth = document.getElementById('birthMonth');

    birthMonth.addEventListener('change', function () {
        const selectedDay = parseInt(birthDay.value, 10);
        const selectedMonth = parseInt(birthMonth.value, 10); 

        if (selectedMonth >= 7 && selectedDay === 31) {
            birthDay.value = 30; 
        }
    });

    birthDay.addEventListener('change', function () {
        const selectedDay = parseInt(birthDay.value, 10); 
        const selectedMonth = parseInt(birthMonth.value, 10); 

        if (selectedMonth >= 7 && selectedDay === 31) {
            birthDay.value = 30;
        }
    });	


</script>
{% endblock script %}



